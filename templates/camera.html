<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capturer une photo</title>
    <!-- CSS externe pour tous les styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- En-t√™te avec bouton retour -->
        <div class="header">
            <a href="/" class="back-btn">‚Üê Retour</a>
            <h1>üì∑ Capturer une photo</h1>
        </div>
        
        <!-- Avertissement de permissions cam√©ra -->
        <div class="warning" id="warning">
            <p>‚ö†Ô∏è Cette fonctionnalit√© n√©cessite l'acc√®s √† votre cam√©ra</p>
        </div>
        
        <!-- Conteneur vid√©o/canvas -->
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" width="480" height="480"></canvas>
        </div>
        
        <!-- Boutons de contr√¥le -->
        <div class="controls">
            <button class="primary-btn" id="startBtn">üé• Activer la cam√©ra</button>
            <button class="secondary-btn" id="captureBtn" disabled>üì∏ Capturer</button>
            <button class="danger-btn" id="retakeBtn" style="display:none;">üîÑ Reprendre</button>
            <button class="primary-btn" id="predictBtn" style="display:none;">üéØ Pr√©dire</button>
        </div>
        
        <!-- Loader pendant le traitement -->
        <div class="loader" id="loader"></div>
        
        <!-- Zone d'affichage des r√©sultats -->
        <div id="results"></div>
    </div>

    <script>
        // ============================================================================
        // √âL√âMENTS DOM
        // ============================================================================
        
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const predictBtn = document.getElementById('predictBtn');
        const loader = document.getElementById('loader');
        const resultsDiv = document.getElementById('results');
        const warning = document.getElementById('warning');
        
        let stream = null;
        let capturedImage = null;
        
        // ============================================================================
        // ACTIVATION DE LA CAM√âRA
        // ============================================================================
        
        /**
         * Active la cam√©ra de l'appareil avec getUserMedia API.
         * Pr√©f√®re la cam√©ra arri√®re sur mobile (facingMode: 'environment').
         */
        startBtn.addEventListener('click', async function() {
            try {
                // Demander l'acc√®s √† la cam√©ra
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 480 },
                        height: { ideal: 480 },
                        facingMode: 'environment' // Cam√©ra arri√®re sur mobile
                    },
                    audio: false
                });
                
                // Connecter le stream vid√©o √† l'√©l√©ment video
                video.srcObject = stream;
                
                // Activer le bouton de capture
                captureBtn.disabled = false;
                startBtn.disabled = true;
                warning.style.display = 'none';
                
                console.log('‚úÖ Cam√©ra activ√©e avec succ√®s');
                
            } catch (error) {
                alert(
                    'Erreur d\'acc√®s √† la cam√©ra: ' + error.message + 
                    '\n\nV√©rifiez que:\n' +
                    '- Vous avez autoris√© l\'acc√®s √† la cam√©ra\n' +
                    '- Vous √™tes sur HTTPS ou localhost\n' +
                    '- Votre navigateur supporte getUserMedia'
                );
                console.error('Camera error:', error);
            }
        });
        
        // ============================================================================
        // CAPTURE DE PHOTO
        // ============================================================================
        
        /**
         * Capture l'image actuelle de la vid√©o sur le canvas.
         */
        captureBtn.addEventListener('click', function() {
            // Dessiner l'image vid√©o actuelle sur le canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Basculer l'affichage: masquer vid√©o, afficher canvas
            video.style.display = 'none';
            canvas.style.display = 'block';
            
            // Modifier les boutons disponibles
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'inline-block';
            predictBtn.style.display = 'inline-block';
            
            // Convertir le canvas en blob pour l'upload
            canvas.toBlob(function(blob) {
                capturedImage = blob;
                console.log('üì∏ Photo captur√©e');
            }, 'image/png');
        });
        
        // ============================================================================
        // REPRENDRE UNE PHOTO
        // ============================================================================
        
        /**
         * Permet de reprendre une nouvelle photo.
         * R√©affiche le flux vid√©o en direct.
         */
        retakeBtn.addEventListener('click', function() {
            // R√©afficher la vid√©o en direct
            video.style.display = 'block';
            canvas.style.display = 'none';
            
            // R√©initialiser les boutons
            captureBtn.style.display = 'inline-block';
            retakeBtn.style.display = 'none';
            predictBtn.style.display = 'none';
            
            // Masquer les r√©sultats pr√©c√©dents
            resultsDiv.style.display = 'none';
            
            console.log('üîÑ Pr√™t pour une nouvelle capture');
        });
        
        // ============================================================================
        // PR√âDICTION
        // ============================================================================
        
        /**
         * Envoie la photo captur√©e au serveur Flask pour obtenir les pr√©dictions.
         */
        predictBtn.addEventListener('click', async function() {
            if (!capturedImage) {
                alert('Aucune image captur√©e');
                return;
            }
            
            // Afficher le loader et masquer le bouton
            loader.style.display = 'block';
            predictBtn.style.display = 'none';
            resultsDiv.style.display = 'none';
            
            // Cr√©er le FormData avec l'image captur√©e
            const formData = new FormData();
            formData.append('file', capturedImage, 'capture.png');
            
            try {
                // Envoyer la requ√™te POST au serveur
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Masquer le loader
                loader.style.display = 'none';
                
                if (response.ok) {
                    // Afficher les r√©sultats
                    displayResults(data);
                } else {
                    // Afficher l'erreur
                    alert('Erreur: ' + data.error);
                    predictBtn.style.display = 'inline-block';
                }
                
            } catch (error) {
                loader.style.display = 'none';
                predictBtn.style.display = 'inline-block';
                alert('Erreur lors de la pr√©diction: ' + error);
                console.error('Prediction error:', error);
            }
        });
        
        // ============================================================================
        // AFFICHAGE DES R√âSULTATS
        // ============================================================================
        
        /**
         * Affiche les r√©sultats des pr√©dictions MLP et CNN.
         * 
         * @param {Object} data - Donn√©es de pr√©diction du serveur
         */
        function displayResults(data) {
            resultsDiv.innerHTML = `
                <h2>üìä R√©sultats de la pr√©diction</h2>
                <div class="results-grid">
                    <div class="result-card">
                        <h3>üß† MLP (Multi-Layer Perceptron)</h3>
                        <div class="prediction">${data.mlp_prediction}</div>
                        <div class="confidence">Confiance: ${data.mlp_confidence}%</div>
                    </div>
                    <div class="result-card">
                        <h3>üîç CNN (Convolutional Neural Network)</h3>
                        <div class="prediction">${data.cnn_prediction}</div>
                        <div class="confidence">Confiance: ${data.cnn_confidence}%</div>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            predictBtn.style.display = 'inline-block';
            
            console.log('‚úÖ R√©sultats affich√©s:', data);
        }
        
        // ============================================================================
        // NETTOYAGE √Ä LA FERMETURE DE LA PAGE
        // ============================================================================
        
        /**
         * Arr√™te proprement le stream vid√©o quand l'utilisateur quitte la page.
         * Cela lib√®re la cam√©ra pour d'autres applications.
         */
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                    console.log('üõë Cam√©ra arr√™t√©e');
                });
            }
        });
    </script>
</body>
</html>
